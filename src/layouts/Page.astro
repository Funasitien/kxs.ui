---
import Head from "./Head.astro";
import Navbar from "../components/Navbar.astro";
import Footer from "../components/Footer.astro";
import { Icon } from "astro-icon/components";

const { frontmatter } = Astro.props;

// Predefine the glob for all potential directories (e.g., `/src/pages/example/*.md`)
const allMarkdownFiles = import.meta.glob("/src/pages/**/*.mdx", {
  eager: true,
});

// Get the current page's route
let currentPath = Astro.url.pathname;
if (currentPath.endsWith("/")) {
  currentPath = currentPath.slice(0, -1);
}

// Filter the files to only include those in the same directory
const currentDir = currentPath.replace(/\/[^/]*$/, "/"); // Get the directory path
const sidebarFilePath = `src/pages${currentDir}.sidebar`;
const sidebarContent = fs.readFileSync(sidebarFilePath, "utf-8");
const sidebarPaths = sidebarContent
    .split("\n")
    .map(line => line.trim())
    .filter(line => line !== "");

console.log(sidebarPaths);

const posts = Object.entries(allMarkdownFiles)
  .filter(([path]) => {
      const targetDir = `/src/pages${currentDir}`;
      return path.startsWith(targetDir) && path.replace(targetDir, "").split("/").length === 1;
  })
  .map(([, module]) => ({
    title: (module as any).frontmatter.title,
    icon: (module as any).frontmatter.icon,
    url: (module as any).url,
  }));
---

<Head title={frontmatter.title} description={frontmatter.description}>
  <Navbar />
  <div class="drawer lg:drawer-open">
    <input id="my-drawer-2" type="checkbox" class="drawer-toggle" />
    <div class="drawer-content max-w-screen">
      <div style="min-height: 80dvh;">
        <h1
          class="text-3xl lg:text-5xl font-bold m-2 my-4 lg:m-4 p-2 bg-primary rounded-lg flex flex-row max-w-fit text-base-100">
          <Icon name={frontmatter.icon} class="translate-y-0.5" />
          <span class="ml-1">{frontmatter.title}</span>
        </h1>
        <article
          class="prose lg:prose-xl mx-2 lg:mx-4"
          style="max-width: none;">
          <slot />
        </article>
      </div>
      <Footer />
    </div>
    <div class="drawer-side">
      <label for="my-drawer-2" aria-label="close sidebar" class="drawer-overlay"
      ></label>
      <ul
        class="menu bg-base-200 text-base-content min-h-full w-80 p-4 relative">
        {
          sidebarPaths.map((post) => (
            <li>
              <a href={post.url}>
                <Icon name={post.icon} /> {post.title}
              </a>
            </li>
          ))
        }
        <li class="absolute bottom-20 pr-10">
          <a href="../">Retour (..)</a>
        </li>
        <li
          class="absolute bottom-5 pr-2"
          style="width: -webkit-fill-available;">
          <select data-choose-theme class="select select-bordered">
            <option value="light">ðŸ’¡ Light</option>
            <option value="dark">ðŸŒ™ Dark</option>
          </select>
        </li>
      </ul>
    </div>
  </div>
</Head>
<script type="module">
  import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs";
  mermaid.initialize({ startOnLoad: true });
</script>
